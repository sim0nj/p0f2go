# p0f2go 项目计划（Agent）

## 项目目标
- 构建可在生产环境稳定运行的被动式 OS 指纹识别 Agent
- 支持 RAW / XDP / TC 三种抓取模式，按环境自动选择或可配置
- 提供可观测性输出（JSON/Prometheus/Kafka/HTTP）与可配置 CLI
- 基于 p0f.fp 的常量库，逐步引入精确签名匹配引擎

## 交付物
- 二进制：p0f-ebpf（RAW）、p0f-ebpf-xdp（XDP/TC）
- 容器镜像：多架构（amd64/arm64）
- 配置：CLI 参数与环境变量；后续支持配置文件
- 文档：使用与部署手册、可观测性集成指南

## 里程碑
- M1（基础稳定）
  - RAW/XDP 抓取稳定运行，边界检查完备
  - CLI 参数：iface/json/rate/sample/dport/sport
  - JSON 文本双输出，标准化字段
  - Docker 构建与运行验证通过
- M2（精确识别）
  - 解析 p0f.fp 规则并实现优先级/冲突处理
  - IPv4/IPv6 支持，选项与窗口/MSS匹配完善
  - 误报率与漏报率评估，规则调优
- M3（可观测性与集成）
  - Prometheus 指标（按 OS 家族/版本计数）
  - Kafka/HTTP 推送（批量/速率控制）
  - 日志格式与字段稳定，加入版本/实例标识
- M4（抓取层增强）
  - 增加 TC（clsact ingress）作为 XDP 的备选
  - eBPF 侧可配置 map（端口/网段过滤与采样）
  - bpf2go 内嵌 .o 与版本管理
- M5（运维与交付）
  - K8s DaemonSet 部署模板，Helm Chart
  - systemd 服务与日志轮转
  - 安全基线（最小权限、容器只读文件系统）

## 技术方案要点
- 抓取层抽象：统一事件结构，RAW/XDP/TC 共享上层解析与检测
- eBPF 程序：严格边界检查、按需扩展事件字段（IP/端口）
- 检测引擎：启发式到签名匹配演进，支持优先级/冲突与兜底
- 可观测性：输出与速率/采样控制，避免噪声与资源过载
- 兼容性：容器化构建 eBPF 对象，缺失头文件自动 fallback

## 验收标准
- 正确性：在已知样本上命中率与误报率达到目标
- 稳定性：长时间运行无崩溃与泄漏，事件速率可控
- 性能：在中等 QPS 下 CPU/内存开销可接受
- 可运维：易部署、易观察、易回滚，日志与指标完善

## 后续工作
- 完备签名匹配与规则管理（含优先级、冲突、兜底）
- IPv6 抓取与检测，扩展 eBPF 解析路径
- 多输出管道与重试/退避策略
- 压测与回归（pcap 重放），完善测试矩阵

## 功能规格与 PRD：可观测性输出与配置化

### 背景与问题陈述
- 当前输出为简单文本标签，难以与监控/日志系统集成
- 需要在不同环境与负载下可控地采样与限速，避免噪声与资源过载
- 不同部署环境有不同抓取模式与网卡，需统一的 CLI/配置规范

### 目标
- 提供结构化输出：JSON（基础），Prometheus（指标），Kafka/HTTP（事件流）
- CLI/配置统一：iface/json/rate/sample/dport/sport 等核心参数
- 稳定运行：在中等 QPS 下限速、采样有效，资源可控

### 非目标
- 不在本迭代实现完整规则引擎的全部精确匹配与权重冲突处理
- 不在本迭代实现复杂的多租户隔离与安全审计

### 用户故事
- 作为平台运维，我希望 Agent 输出 JSON，便于通过日志管道（FluentBit/Vector）收集到 SIEM
- 作为监控负责人，我希望按 OS 家族聚合指标并导出 Prometheus，便于设定告警阈值
- 作为网络工程师，我希望配置采样比例与每秒最大事件数，确保在峰值时系统稳定
- 作为安全分析师，我希望按端口或网段过滤，减少无关事件

### 需求优先级
- Must
  - JSON 输出（含 src/dst IP、端口、TTL、Win、MSS、选项、ECN、Label）
  - CLI 参数：iface/json/rate/sample/sport/dport
  - 统一 RAW/XDP 行为与字段
- Should
  - Prometheus 指标：按 label（OS 家族/版本）计数、采样率、丢弃数
  - HTTP 推送（批量），带重试/退避
- Could
  - Kafka 推送，Topic 与分区策略可配置
  - 环境变量与配置文件互通（优先级：CLI > ENV > 配置文件）

### 成功指标
- 事件正确率：在标注样本上 JSON 字段完整且可解析，错误率 < 0.5%
- 性能与稳定：在 10k events/min 负载下 CPU < 1 核、内存 < 200MB
- 可观测性：Prometheus 暴露至少 5 个核心指标；JSON 可直接入管道

### 范围管理
- 范围内：JSON 输出与 CLI 参数实现；XDP 事件补充地址与端口；限速与采样
- 范围外：复杂规则引擎、跨租户安全审计、UI 控制面

### 依赖与约束
- 运行环境：Linux 宿主（XDP/TC），容器内需特权与 host 网络
- 语言与库：Go 1.21+，cilium/ebpf；容器内 clang/llvm 构建 eBPF
- 兼容性：RAW 作为通用后备路径，XDP/TC 按环境启用

### 风险与缓解
- 风险：XDP 在部分驱动/内核上不可用
  - 缓解：自动回退 RAW 或提供 TC 模式
- 风险：高峰期事件洪泛
  - 缓解：rate 与 sample 双控；批量推送与退避策略

### 验收标准
- CLI/ENV 参数生效并有帮助信息；JSON 字段稳定且通过样例校验
- 在容器内 RAW/XDP 均可运行；限速与采样正确
- 提供集成示例与最小 Prometheus 指标集

### 发布计划
- M1 发布：JSON 输出 + CLI/配置 + XDP 地址/端口 + 限速/采样
- M3 扩展：Prometheus/HTTP 推送与集成指南
